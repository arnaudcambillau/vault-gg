{% extends 'base_app.html.twig' %}

{% block title %}Mon Profil - Vault.gg{% endblock %}

{% block content %}

<!-- Messages flash -->
{% for label, messages in app.flashes %}
    {% for message in messages %}
        <div class="p-4 rounded-lg mb-4 
            {% if label == 'success' %}bg-green-500/20 border border-green-500/30 text-green-400{% endif %}
            {% if label == 'error' %}bg-red-500/20 border border-red-500/30 text-red-400{% endif %}">
            {{ message }}
        </div>
    {% endfor %}
{% endfor %}

<!-- En-t√™te -->
<div class="mb-6">
    <h1 class="text-3xl font-black mb-2 flex items-center gap-3">
        <i data-lucide="user" class="w-9 h-9 text-indigo-500"></i>
        Mon Profil
    </h1>
    <p class="text-slate-400">Informations et statistiques de votre compte</p>
</div>

<!-- Carte principale du profil -->
<div class="glass p-8 mb-6">
    <div class="flex items-center gap-6 flex-wrap">
        
        <!-- Avatar cliquable -->
        <div class="relative cursor-pointer" 
            onclick="document.getElementById('avatar-form-section').style.display = 'block'; lucide.createIcons();">
            {% if user.avatar %}
                <img src="{{ asset('uploads/avatars/' ~ user.avatar) }}" 
                    alt="Avatar" 
                    class="w-[104px] h-[104px] rounded-full object-cover shadow-xl shadow-indigo-500/40">
            {% else %}
                <div class="w-[104px] h-[104px] rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 
                            flex items-center justify-center text-4xl font-black text-white shadow-xl shadow-indigo-500/40">
                    {{ user.username|first|upper }}
                </div>
            {% endif %}
            
            <!-- Ic√¥ne overlay -->
            <div class="absolute bottom-0 right-0 w-8 h-8 bg-gradient-to-br from-indigo-500 to-violet-500 
                        rounded-full flex items-center justify-center border-2 border-slate-800 shadow-lg shadow-indigo-500/40">
                <i data-lucide="camera" class="w-4 h-4 text-white"></i>
            </div>
        </div>
        
        <!-- Informations -->
        <div class="flex-1 min-w-[250px]">
            <h2 class="text-3xl font-black text-slate-100 mb-2">
                {{ user.username }}
            </h2>
            <div class="flex flex-col gap-2 text-slate-400">
                <div class="flex items-center gap-2">
                    <i data-lucide="mail" class="w-4 h-4"></i>
                    <span>{{ user.email }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span>Membre depuis {{ "now"|date('Y') }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="shield" class="w-4 h-4"></i>
                    <span>Compte v√©rifi√©</span>
                </div>
            </div>
        </div>

        <!-- Badge niveau -->
        <div class="text-center">
            <div class="w-20 h-20 rounded-full bg-amber-500/20 border-[3px] border-amber-500 
                        flex flex-col items-center justify-center mx-auto mb-2">
                <i data-lucide="trophy" class="w-8 h-8 text-amber-500"></i>
            </div>
            <div class="text-xs font-semibold text-slate-400 uppercase">Collectionneur</div>
        </div>
    </div>
</div>

<!-- Formulaire d'upload d'avatar (cach√© par d√©faut) -->
<div id="avatar-form-section" class="glass p-6 mb-6 hidden">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold flex items-center gap-2 m-0">
            <i data-lucide="image" class="w-5 h-5 text-indigo-500"></i>
            Changer la photo de profil
        </h2>
        <button onclick="document.getElementById('avatar-form-section').style.display = 'none';" 
                class="bg-slate-700/20 text-slate-400 px-3 py-1.5 rounded-md border border-slate-700/30 
                       cursor-pointer font-semibold flex items-center gap-1 transition-all hover:bg-slate-700/30">
            <i data-lucide="x" class="w-4 h-4"></i>
            Fermer
        </button>
    </div>
    
    {{ form_start(avatarForm, {'action': path('app_profile_upload_avatar'), 'attr': {'enctype': 'multipart/form-data'}}) }}
        <div class="flex gap-3 items-end">
            <div class="flex-1">
                {{ form_widget(avatarForm.avatar, {
                    'attr': {
                        'class': 'w-full p-2.5 bg-slate-800/80 border border-indigo-500/30 rounded-lg text-slate-100 cursor-pointer'
                    }
                }) }}
                {{ form_errors(avatarForm.avatar) }}
                <p class="text-slate-400 text-xs mt-1.5">
                    Formats accept√©s : JPG, PNG, GIF, WEBP ‚Ä¢ Taille max : 2MB
                </p>
            </div>
            <button type="submit" 
                    class="bg-gradient-to-br from-indigo-500 to-violet-500 text-white px-6 py-2.5 rounded-lg 
                           border-0 cursor-pointer font-semibold whitespace-nowrap flex items-center gap-1.5 transition-all hover:-translate-y-0.5">
                <i data-lucide="upload" class="w-4 h-4"></i>
                Uploader
            </button>
        </div>
    {{ form_end(avatarForm) }}
</div>

<!-- Statistiques en grille -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    
    <!-- Total jeux -->
    <div class="glass p-5 text-center">
        <div class="w-12 h-12 bg-indigo-500/20 rounded-xl flex items-center justify-center mx-auto mb-3">
            <i data-lucide="library" class="w-6 h-6 text-indigo-500"></i>
        </div>
        <div class="text-3xl font-black text-slate-100 mb-1">{{ stats.total }}</div>
        <div class="text-xs text-slate-400 uppercase font-semibold">Jeux au total</div>
    </div>

    <!-- Favoris -->
    <div class="glass p-5 text-center">
        <div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center mx-auto mb-3">
            <i data-lucide="heart" class="w-6 h-6 text-red-500"></i>
        </div>
        <div class="text-3xl font-black text-red-500 mb-1">{{ stats.favorites }}</div>
        <div class="text-xs text-slate-400 uppercase font-semibold">Favoris</div>
    </div>

    <!-- Termin√©s -->
    <div class="glass p-5 text-center">
        <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center mx-auto mb-3">
            <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
        </div>
        <div class="text-3xl font-black text-green-500 mb-1">{{ stats.completed }}</div>
        <div class="text-xs text-slate-400 uppercase font-semibold">Termin√©s</div>
    </div>

    <!-- Taux de compl√©tion -->
    <div class="glass p-5 text-center">
        <div class="w-12 h-12 bg-violet-500/20 rounded-xl flex items-center justify-center mx-auto mb-3">
            <i data-lucide="trending-up" class="w-6 h-6 text-violet-500"></i>
        </div>
        <div class="text-3xl font-black text-violet-500 mb-1">{{ completionRate }}%</div>
        <div class="text-xs text-slate-400 uppercase font-semibold">Compl√©tion</div>
    </div>
</div>

<!-- Progression par statut -->
<div class="glass p-6 mb-6">
    <h2 class="text-lg font-bold mb-5 flex items-center gap-2">
        <i data-lucide="bar-chart" class="w-5 h-5 text-indigo-500"></i>
        Progression par statut
    </h2>
    
    <div class="flex flex-col gap-4">
        
        <!-- Backlog -->
        <div>
            <div class="flex justify-between mb-2">
                <span class="font-semibold text-slate-100 flex items-center gap-1.5">
                    <i data-lucide="clock" class="w-4 h-4 text-slate-500"></i>
                    Backlog
                </span>
                <span class="font-bold text-slate-500">{{ stats.backlog }} jeu{% if stats.backlog > 1 %}x{% endif %}</span>
            </div>
            <div class="bg-slate-800/60 h-3 rounded-md overflow-hidden">
                <div class="bg-gradient-to-r from-slate-500 to-slate-600 h-full transition-all duration-500" 
                     style="width: {% if stats.total > 0 %}{{ (stats.backlog / stats.total * 100)|round }}%{% else %}0%{% endif %}"></div>
            </div>
        </div>

        <!-- En cours -->
        <div>
            <div class="flex justify-between mb-2">
                <span class="font-semibold text-slate-100 flex items-center gap-1.5">
                    <i data-lucide="play-circle" class="w-4 h-4 text-amber-500"></i>
                    En cours
                </span>
                <span class="font-bold text-amber-500">{{ stats.in_progress }} jeu{% if stats.in_progress > 1 %}x{% endif %}</span>
            </div>
            <div class="bg-slate-800/60 h-3 rounded-md overflow-hidden">
                <div class="bg-gradient-to-r from-amber-500 to-amber-600 h-full transition-all duration-500" 
                     style="width: {% if stats.total > 0 %}{{ (stats.in_progress / stats.total * 100)|round }}%{% else %}0%{% endif %}"></div>
            </div>
        </div>

        <!-- Termin√© -->
        <div>
            <div class="flex justify-between mb-2">
                <span class="font-semibold text-slate-100 flex items-center gap-1.5">
                    <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                    Termin√©
                </span>
                <span class="font-bold text-green-500">{{ stats.completed }} jeu{% if stats.completed > 1 %}x{% endif %}</span>
            </div>
            <div class="bg-slate-800/60 h-3 rounded-md overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-green-600 h-full transition-all duration-500" 
                     style="width: {% if stats.total > 0 %}{{ (stats.completed / stats.total * 100)|round }}%{% else %}0%{% endif %}"></div>
            </div>
        </div>
    </div>
</div>

<!-- Activit√© r√©cente -->
<div class="glass p-6">
    <h2 class="text-lg font-bold mb-5 flex items-center gap-2">
        <i data-lucide="activity" class="w-5 h-5 text-indigo-500"></i>
        Activit√© r√©cente
    </h2>
    
    {% if recentGames|length > 0 %}
        <div class="flex flex-col gap-3">
            {% for userGame in recentGames %}
                {% set game = userGame.game %}
                <div class="flex items-center gap-4 p-3 bg-slate-800/40 rounded-lg">
                    
                    <!-- Image -->
                    {% if game.backgroundImage %}
                        <img src="{{ game.backgroundImage }}" 
                            alt="{{ game.name }}" 
                            class="w-20 h-15 object-cover rounded-md">
                    {% else %}
                        <div class="w-20 h-15 bg-indigo-500/20 rounded-md flex items-center justify-center">
                            <i data-lucide="gamepad-2" class="w-6 h-6 text-indigo-500"></i>
                        </div>
                    {% endif %}
                    
                    <!-- Info -->
                    <div class="flex-1">
                        <div class="font-bold text-slate-100 mb-1">{{ game.name }}</div>
                        <div class="flex items-center gap-2 flex-wrap">
                            
                            <!-- Statut -->
                            {% if userGame.status == 'backlog' %}
                                <span class="bg-slate-700/20 text-slate-400 px-2 py-0.5 rounded text-[11px] font-semibold">üìö Backlog</span>
                            {% elseif userGame.status == 'in_progress' %}
                                <span class="bg-amber-500/20 text-amber-500 px-2 py-0.5 rounded text-[11px] font-semibold">üéÆ En cours</span>
                            {% elseif userGame.status == 'completed' %}
                                <span class="bg-green-500/20 text-green-500 px-2 py-0.5 rounded text-[11px] font-semibold">‚úÖ Termin√©</span>
                            {% endif %}
                            
                            <!-- Favori -->
                            {% if userGame.isFavorite %}
                                <span class="bg-red-500/20 text-red-500 px-2 py-0.5 rounded text-[11px] font-semibold">‚ù§Ô∏è Favori</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Date -->
                    <div class="text-right text-slate-400 text-xs">
                        <div class="flex items-center gap-1">
                            <i data-lucide="plus-circle" class="w-3 h-3"></i>
                            {{ userGame.addedAt|date('d/m/Y') }}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-slate-400 text-center py-6">
            Aucune activit√© r√©cente
        </p>
    {% endif %}
</div>

{% endblock %}
